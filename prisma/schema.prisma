// schema.prisma

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "mysql"
  url      = env("DATABASE_URL")
}

enum Role {
  SUPER_ADMIN
  BRANCH_ADMIN
  MANAGER
  STAFF
  TRAINER
  MEMBER
}

// --- CORE MODELS ---

model Tenant {
  id         Int      @id @default(autoincrement())
  name       String
  branchName String?
  owner      String?
  email      String?
  phone      String?
  location   String?
  status     String   @default("Active") // Active, Suspended
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  users               User[]
  plans               MembershipPlan[]
  members             Member[]
  leads               Lead[]
  classes             Class[]
  inventory           Inventory[]
  lockers             Locker[]
  equipment           Equipment[]
  invoices            Invoice[]
  expenses            Expense[]
  payroll             Payroll[]
  devices             Device[]
  settings            TenantSettings?
  Announcement        Announcement[]
  Reward              Reward[]
  RewardCatalog       RewardCatalog[]
  Feedback            Feedback[]
  Attendance          Attendance[]
  LeaveRequest        LeaveRequest[]
  trainerAvailability   TrainerAvailability[]
  dietPlans             DietPlan[]
  workoutPlans          WorkoutPlan[]
  serviceRequests       ServiceRequest[]
  amenities             Amenity[]
  promoCodes            PromoCode[]

  @@map("tenant")
}

model User {
  id       Int     @id @default(autoincrement())
  email    String  @unique
  password String
  name     String
  phone    String?
  address  String? @db.Text
  role     Role
  status   String  @default("Active")
  avatar   String?
  tenantId Int? // Null for Superadmin
  tenant   Tenant? @relation(fields: [tenantId], references: [id])

  // Staff Specific Fields
  department    String?
  baseSalary    Decimal? @db.Decimal(10, 2)
  commission    Decimal? @db.Decimal(5, 2) @default(0.00)
  accountNumber String?
  ifsc          String?
  config        Json? // To store trainerConfig, salesConfig, managerConfig
  shift         String?  
  dob           DateTime?
  documents     Json? // To store document URLs (govtId, contract)

  joinedDate DateTime  @default(now())
  lastLogin  DateTime?

  // Relations
  authoredAnnouncements Announcement[]
  assignedTasks         Task[]               @relation("AssignedTasks")
  createdTasks          Task[]               @relation("CreatedTasks")
  assignedMember        Member[]             @relation("TrainerToMember")
  assignedLeads         Lead[]               @relation("LeadAssignee")
  attendances           Attendance[]
  classes               Class[]
  LeaveRequest          LeaveRequest[]
  trainerAvailability   TrainerAvailability?
  trainerDietPlans      DietPlan[]           @relation("TrainerDietPlan")
  trainerWorkoutPlans   WorkoutPlan[]        @relation("TrainerWorkoutPlan")
  member                Member[]             @relation("UserToMember")

  @@map("user")
}

// --- SUPERADMIN MODELS ---

model SaaSPlan {
  id          Int      @id @default(autoincrement())
  name        String
  description String?  @db.Text
  price       Decimal  @db.Decimal(10, 2)
  period      String // Monthly, Yearly
  features    Json? // Array of feature flags
  limits      Json? // Organization limits
  opsLimits   Json? // Operational limits
  benefits    Json? // Member benefits
  status      String   @default("Active")
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@map("saasplan")
}

model Subscription {
  id            String   @id @default(uuid())
  tenantId      Int
  planId        Int
  subscriber    String
  startDate     DateTime
  endDate       DateTime
  status        String // Active, Expired, Due
  paymentStatus String // Paid, Pending, Overdue

  @@map("subscription")
}

model AuditLog {
  id             Int      @id @default(autoincrement())
  userId         Int
  action         String
  affectedEntity String?
  details        String?  @db.Text
  module         String
  ip             String?
  createdAt      DateTime @default(now())

  @@map("auditlog")
}

model WebhookLog {
  id         String   @id @default(uuid())
  event      String
  status     String
  method     String
  endpoint   String
  statusCode Int
  payload    Json?
  createdAt  DateTime @default(now())

  @@map("webhooklog")
}

model SaaSSettings {
  id             Int     @id @default(autoincrement())
  siteName       String  @default("Gym CRM")
  supportEmail   String?
  contactPhone   String?
  contactAddress String? @db.Text
  currency       String  @default("INR")
  timezone       String  @default("IST")

  // Invoice Global Settings
  invoicePrefix      String  @default("INV-")
  invoiceStartNumber Int     @default(1001)
  gstPercent         Decimal @default(18.00) @db.Decimal(5, 2)

  // Booking Global Settings
  bookingEnabled     Boolean @default(true)
  creditsPerBooking  Int     @default(1)
  maxBookingsPerDay  Int     @default(2)
  maxBookingsPerWeek Int     @default(10)

  // Classes specific
  classCancellationWindow Int     @default(4) // Hours
  classAdvanceBookingDays Int     @default(7)

  // Benfits specific
  benefitCancellationWindow Int     @default(24) // Hours
  benefitAdvanceBookingDays Int     @default(14)

  penaltyEnabled     Boolean @default(true)
  penaltyCredits     Int     @default(1)

  @@map("saassettings")
}

model SaasPayment {
  id         String   @id @default(uuid())
  paymentId  String   @unique
  tenantId   Int
  tenantName String
  amount     Decimal  @db.Decimal(10, 2)
  method     String
  status     String   @default("Success")
  date       DateTime @default(now())

  @@map("saaspayment")
}

model Device {
  id           Int      @id @default(autoincrement())
  tenantId     Int?
  tenant       Tenant?  @relation(fields: [tenantId], references: [id])
  name         String
  type         String
  ipAddress    String? // Optional IP address
  status       String   @default("connected") // connected, error, disconnected
  entriesToday Int      @default(0) // Tracks entries
  message      String?
  lastSeen     DateTime @default(now())

  @@map("device")
}

// --- ADMIN / BRANCH MODELS ---

model Member {
  id       Int    @id @default(autoincrement())
  memberId String @unique // MEM-2024-001
  userId   Int?   @unique
  tenantId Int
  tenant   Tenant @relation(fields: [tenantId], references: [id])
  user     User?  @relation("UserToMember", fields: [userId], references: [id])

  name     String?
  email    String?
  phone    String?
  gender   String?
  avatar   String? // Cloudinary URL for Face ID
  benefits Json? // Array of benefit IDs or detailed JSON

  planId     Int?
  plan       MembershipPlan? @relation(fields: [planId], references: [id])
  joinDate   DateTime        @default(now())
  expiryDate DateTime?
  status     String          @default("Active") // Active, Expired, Inactive

  trainerId Int?
  trainer   User? @relation("TrainerToMember", fields: [trainerId], references: [id])

  // Onboarding & Medical
  medicalHistory String? @db.Text
  fitnessGoal    String?
  targetWeight   Decimal? @db.Decimal(5, 2)
  targetBodyFat  Decimal? @db.Decimal(5, 2)
  emergencyName  String?
  emergencyPhone String?
  height         Decimal? @db.Decimal(5, 2)

  bookings Booking[]
  wallet   Wallet?
  progress MemberProgress[]
  Reward   Reward[]
  Feedback Feedback[]
  dietPlans DietPlan[]
  workoutPlans WorkoutPlan[]
  serviceRequests ServiceRequest[]

  cards          Json?

  storeOrders    StoreOrder[]
  invoices       Invoice[]

  @@map("member")
}

model MembershipPlan {
  id           Int     @id @default(autoincrement())
  tenantId     Int
  tenant       Tenant  @relation(fields: [tenantId], references: [id])
  name         String
  price        Decimal @db.Decimal(10, 2)
  duration     Int // Number (e.g., 12)
  durationType String  @default("Months") // Months, Days, Years
  description  String? @db.Text

  // Booking Rules
  creditsPerBooking  Int @default(1)
  maxBookingsPerDay  Int @default(1)
  maxBookingsPerWeek Int @default(7)
  cancellationWindow Int @default(4) // Hours

  benefits  Json? // Array of { id, limit }
  status    String   @default("Active")
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  members Member[]

  @@map("membershipplan")
}

model Lead {
  id        Int        @id @default(autoincrement())
  tenantId  Int
  tenant    Tenant     @relation(fields: [tenantId], references: [id])
  name      String
  email     String?
  phone     String
  source    String?
  status    String     @default("New") // New, Contacted, Qualified, Converted, Lost
  followUps FollowUp[]
  createdAt DateTime   @default(now())
  updatedAt DateTime   @updatedAt

  // Extended Fields for Inquiry Form
  gender           String?
  age              Int?
  interests        Json? // Array of strings
  budget           String?
  preferredContact String? @default("WhatsApp")

  assignedToId Int?
  assignedTo   User? @relation("LeadAssignee", fields: [assignedToId], references: [id])

  notes        String?   @db.Text
  nextFollowUp DateTime?

  @@map("lead")
}

model FollowUp {
  id        Int       @id @default(autoincrement())
  leadId    Int
  lead      Lead      @relation(fields: [leadId], references: [id])
  notes     String?
  status    String
  nextDate  DateTime?
  createdAt DateTime  @default(now())

  @@map("followup")
}

model Class {
  id              Int       @id @default(autoincrement())
  tenantId        Int
  tenant          Tenant    @relation(fields: [tenantId], references: [id])
  name            String
  description     String?   @db.Text
  trainerId       Int?
  trainer         User?     @relation(fields: [trainerId], references: [id])
  schedule        Json // Days and times
  duration        String?
  maxCapacity     Int
  status          String    @default("Scheduled")
  location        String?
  requiredBenefit String?
  bookings        Booking[]

  @@map("class")
}

model Booking {
  id       Int      @id @default(autoincrement())
  memberId Int
  member   Member   @relation(fields: [memberId], references: [id])
  classId  Int
  class    Class    @relation(fields: [classId], references: [id])
  date     DateTime
  status   String   @default("Upcoming") // Upcoming, Completed, Cancelled

  @@map("booking")
}

model Inventory {
  id           Int     @id @default(autoincrement())
  tenantId     Int?
  tenant       Tenant? @relation(fields: [tenantId], references: [id])
  itemName     String
  category     String
  quantity     Int
  unit         String
  minThreshold Int     @default(5)
  status       String  @default("In Stock")

  @@map("inventory")
}

model Locker {
  id           Int     @id @default(autoincrement())
  tenantId     Int?
  tenant       Tenant? @relation(fields: [tenantId], references: [id])
  number       String
  status       String    @default("Available") // Available, Occupied, Under Maintenance
  assignedToId Int?
  expiryDate   DateTime?
  notes        String?   @db.Text

  @@map("locker")
}

model Equipment {
  id             Int                  @id @default(autoincrement())
  tenantId       Int?
  tenant         Tenant?              @relation(fields: [tenantId], references: [id])
  name           String
  brand          String?
  model          String?
  serialNumber   String?
  category       String?
  location       String?
  purchaseDate   DateTime?
  warrantyExpiry DateTime?
  status         String               @default("Operational") // Operational, Maintenance, Out of Order
  lastService    DateTime?
  nextService    DateTime?
  maintenance    MaintenanceRequest[]

  @@map("equipment")
}

model MaintenanceRequest {
  id          Int       @id @default(autoincrement())
  equipmentId Int
  equipment   Equipment @relation(fields: [equipmentId], references: [id])
  issue       String
  priority    String // Low, Medium, High
  status      String    @default("Pending")
  createdAt   DateTime  @default(now())

  @@map("maintenancerequest")
}

model Invoice {
  id            Int       @id @default(autoincrement())
  tenantId      Int
  tenant        Tenant    @relation(fields: [tenantId], references: [id])
  invoiceNumber String    @unique
  memberId      Int
  amount        Decimal   @db.Decimal(10, 2)
  paymentMode   String    @default("Cash") // Cash, UPI, Card
  status        String    @default("Unpaid") // Paid, Unpaid, Partial, Cancelled
  dueDate       DateTime
  paidDate      DateTime?
  member        Member    @relation(fields: [memberId], references: [id])

  @@map("invoice")
}

model Expense {
  id       Int      @id @default(autoincrement())
  tenantId Int
  tenant   Tenant   @relation(fields: [tenantId], references: [id])
  title    String
  category String
  amount   Decimal  @db.Decimal(10, 2)
  date     DateTime
  status   String   @default("Paid")
  notes    String?  @db.Text
  addedBy  String?

  @@map("expense")
}

model Payroll {
  id       Int     @id @default(autoincrement())
  tenantId Int
  tenant   Tenant  @relation(fields: [tenantId], references: [id])
  staffId  Int
  amount      Decimal @db.Decimal(10, 2)
  incentives  Decimal @default(0.00) @db.Decimal(10, 2)
  deductions  Decimal @default(0.00) @db.Decimal(10, 2)
  month       Int
  year        Int
  status      String  @default("Pending") // Pending, Processed

  @@map("payroll")
}

model Attendance {
  id       Int       @id @default(autoincrement())
  tenantId Int       @default(1)
  tenant   Tenant    @relation(fields: [tenantId], references: [id])
  userId   Int
  user     User      @relation(fields: [userId], references: [id])
  date     DateTime  @default(now()) @db.Date
  checkIn  DateTime?
  checkOut DateTime?
  status   String    @default("Present") // Present, Late, Absent, On Leave
  type     String // Member, Staff, Trainer

  @@map("attendance")
}

model LeaveRequest {
  id        Int      @id @default(autoincrement())
  tenantId  Int      @default(1)
  tenant    Tenant   @relation(fields: [tenantId], references: [id])
  userId    Int
  user      User     @relation(fields: [userId], references: [id])
  type      String   @default("Vacation") // Vacation, Sick, Personal
  startDate DateTime
  endDate   DateTime
  reason    String   @db.Text
  status    String   @default("Pending") // Pending, Approved, Rejected
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("leave_request")
}

model TrainerAvailability {
  id             Int      @id @default(autoincrement())
  tenantId       Int      @default(1)
  tenant         Tenant   @relation(fields: [tenantId], references: [id])
  trainerId      Int      @unique
  trainer        User     @relation(fields: [trainerId], references: [id])
  weeklySchedule Json // Stores the array of availability objects
  preferences    Json // Stores preferences (e.g. instantBooking)
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  @@map("trainer_availability")
}

model Task {
  id           Int      @id @default(autoincrement())
  title        String
  assignedToId Int
  assignedTo   User     @relation("AssignedTasks", fields: [assignedToId], references: [id])
  creatorId    Int
  creator      User     @relation("CreatedTasks", fields: [creatorId], references: [id])
  priority     String
  dueDate      DateTime
  status       String   @default("Pending")

  @@map("task")
}

model Wallet {
  id           Int           @id @default(autoincrement())
  memberId     Int           @unique
  member       Member        @relation(fields: [memberId], references: [id])
  balance      Decimal       @default(0) @db.Decimal(10, 2)
  transactions Transaction[]

  @@map("wallet")
}

model Transaction {
  id          Int      @id @default(autoincrement())
  walletId    Int
  wallet      Wallet   @relation(fields: [walletId], references: [id])
  amount      Decimal  @db.Decimal(10, 2)
  type        String // Credit, Debit
  description String?
  createdAt   DateTime @default(now())

  @@map("transaction")
}

model MemberProgress {
  id           Int      @id @default(autoincrement())
  memberId     Int
  member       Member   @relation(fields: [memberId], references: [id])
  weight       Decimal? @db.Decimal(5, 2)
  bodyFat      Decimal? @db.Decimal(5, 2)
  measurements Json?
  photos       Json?
  notes        String?
  height       Decimal? @db.Decimal(5, 2)
  date         DateTime @default(now())

  @@map("memberprogress")
}

model Announcement {
  id         Int      @id @default(autoincrement())
  tenantId   Int?
  tenant     Tenant?  @relation(fields: [tenantId], references: [id])
  title      String
  content    String   @db.Text
  priority   String   @default("medium") // high, medium, low
  targetRole String   @default("all") // all, member, trainer, staff
  authorId   Int
  author     User     @relation(fields: [authorId], references: [id])
  createdAt  DateTime @default(now())

  @@map("announcement")
}

model TenantSettings {
  id              Int     @id @default(autoincrement())
  tenantId        Int     @unique
  tenant          Tenant  @relation(fields: [tenantId], references: [id])
  logo            String?
  timezone        String  @default("UTC")
  currency        String  @default("USD")
  whatsappEnabled Boolean @default(false)

  // Developer & Integration Settings
  webhooks           Json? // { payment: '', whatsapp: '', attendance: '', secret: '' }
  
  // Payment Gateways & APIs
  apiKeys            Json? // { razorpay: { key: '', secret: '' }, sms: '', whatsapp: '' }

  // Invoice Settings
  invoicePrefix      String  @default("INV-")
  invoiceStartNumber Int     @default(1001)
  gstPercent         Decimal @default(18.00) @db.Decimal(5, 2)
  
  // Message Templates
  messageTemplates Json? // Array of { id, name, content, trigger }

  @@map("tenantsettings")
}

model Reward {
  id          Int      @id @default(autoincrement())
  tenantId    Int?
  tenant      Tenant?  @relation(fields: [tenantId], references: [id])
  memberId    Int?
  member      Member?  @relation(fields: [memberId], references: [id])
  name        String   @default("Reward")
  points      Int      @default(0)
  description String   @default("")
  date        DateTime @default(now())

  @@map("reward")
}

model RewardCatalog {
  id          Int      @id @default(autoincrement())
  tenantId    Int
  tenant      Tenant   @relation(fields: [tenantId], references: [id])
  name        String
  points      Int
  description String   @db.Text
  status      String   @default("Active")

  @@map("rewardcatalog")
}

model Feedback {
  id       Int      @id @default(autoincrement())
  tenantId Int?
  tenant   Tenant?  @relation(fields: [tenantId], references: [id])
  memberId Int?
  member   Member?  @relation(fields: [memberId], references: [id])
  rating   Int
  comment  String   @db.Text
  status   String   @default("Pending") // Pending, Addressed
  date     DateTime @default(now())

  @@map("feedback")
}

model ServiceRequest {
  id        Int      @id @default(autoincrement())
  tenantId  Int      @default(1)
  tenant    Tenant   @relation(fields: [tenantId], references: [id])
  memberId  Int
  member    Member   @relation(fields: [memberId], references: [id])
  
  type      String   // Freeze Request, Trainer Change, etc.
  details   String?  @db.Text
  status    String   @default("Pending") // Pending, Approved, Rejected
  rawType   String?  // Freeze, TrainerChange, General
  date      DateTime @default(now())
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("service_request")
}

model DietPlan {
  id        String   @id @default(uuid())
  tenantId  Int      @default(1)
  tenant    Tenant   @relation(fields: [tenantId], references: [id])
  trainerId Int
  trainer   User     @relation("TrainerDietPlan", fields: [trainerId], references: [id])
  clientId  Int
  client    Member   @relation(fields: [clientId], references: [id])
  
  name      String
  target    String
  duration  String
  calories  Int
  macros    Json     // { protein, carbs, fats }
  meals     Json     // array of meal objects
  notes     String?  @db.Text
  status    String   @default("Active")
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("diet_plan")
}

model WorkoutPlan {
  id             String   @id @default(uuid())
  tenantId       Int      @default(1)
  tenant         Tenant   @relation(fields: [tenantId], references: [id])
  trainerId      Int
  trainer        User     @relation("TrainerWorkoutPlan", fields: [trainerId], references: [id])
  clientId       Int
  client         Member   @relation(fields: [clientId], references: [id])
  
  name           String
  level          String   @default("Beginner")
  duration       String
  goal           String
  volume         String
  timePerSession String
  intensity      String
  status         String   @default("Active")
  days           Json     // object containing monday-sunday routines
  
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  @@map("workout_plan")
}

model StoreProduct {
  id            Int      @id @default(autoincrement())
  tenantId      Int      @default(1)
  name          String
  sku           String?
  category      String
  price         Decimal  @db.Decimal(10, 2)
  originalPrice Decimal? @db.Decimal(10, 2)
  rating        Decimal? @db.Decimal(2, 1) @default(5.0)
  image         String?  @db.Text
  description   String?  @db.Text
  stock         Int      @default(0)
  status        String   @default("Active") // Active, Out of Stock, Inactive

  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
  
  orderItems    StoreOrderItem[]

  @@map("store_product")
}

model StoreOrder {
  id         String   @id @default(uuid())
  tenantId   Int      @default(1)
  memberId   Int
  member     Member   @relation(fields: [memberId], references: [id])
  itemsCount Int      @default(0)
  total      Decimal  @db.Decimal(10, 2)
  status     String   @default("Processing") // Processing, Delivered, Cancelled
  date       DateTime @default(now())

  items      StoreOrderItem[]

  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  @@map("store_order")
}

model StoreOrderItem {
  id         Int          @id @default(autoincrement())
  orderId    String
  order      StoreOrder   @relation(fields: [orderId], references: [id])
  productId  Int
  product    StoreProduct @relation(fields: [productId], references: [id])
  quantity   Int          @default(1)
  priceAtBuy Decimal      @db.Decimal(10, 2) // Stored to prevent historical price changes from affecting past orders

  @@map("store_order_item")
}

model Amenity {
  id          Int      @id @default(autoincrement())
  tenantId    Int
  tenant      Tenant   @relation(fields: [tenantId], references: [id])
  name        String
  description String?  @db.Text
  icon        String? // Name of the icon (lucide-react)
  status      String   @default("Active") // Active, Inactive
  gender      String   @default("UNISEX") // MALE, FEMALE, UNISEX
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@map("amenity")
}

model PromoCode {
  id          Int       @id @default(autoincrement())
  tenantId    Int       @default(1)
  tenant      Tenant    @relation(fields: [tenantId], references: [id])
  code        String    @unique
  type        String    @default("PERCENTAGE") // PERCENTAGE, FLAT
  value       Decimal   @db.Decimal(10, 2)
  status      String    @default("Active") // Active, Inactive
  expiryDate  DateTime?
  usageLimit  Int?
  usedCount   Int       @default(0)
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  @@map("promo_code")
}
